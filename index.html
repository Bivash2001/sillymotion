<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Marz's SillyMotion</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    #controls { margin: 10px 0; }
    #timeline { display: flex; overflow-x: auto; border: 1px solid #ccc; padding: 5px; min-height: 100px; }
    .frame-thumb { margin: 2px; border: 1px solid #999; cursor: grab; position: relative; }
    .frame-thumb.dragging { opacity: 0.5; }
    .frame-thumb img { width: 60px; height: 45px; display: block; }
    .selected { border: 2px solid red; }
    .frame-actions { display: flex; justify-content: center; margin-top: 2px; }
    .frame-actions button { font-size: 10px; margin: 0 1px; }
  </style>
</head>
<body>
  <h1>Marz's SillyMotion</h1>
  <p><a href="README.txt" target="_blank">ðŸ“– Read Me (Instructions & Features)</a></p>

  <div style="display:flex; gap:20px;">
    <div>
      <h3>Camera Feed (Be Sure to Grab a Webcam)</h3>
      <canvas id="liveCanvas" width="320" height="240" style="border:1px solid #ccc;"></canvas>
      <video id="webcam" autoplay playsinline width="320" height="240" style="display:none;"></video>
      <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    </div>
    <div>
      <h3>Playback Preview</h3>
      <img id="playbackPreview" width="320" height="240" style="border:1px solid #ccc;">
    </div>
  </div>

  <div id="controls">
    <button id="captureBtn">Capture Frame</button>
    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>
    <button id="exportBtn">Export WebM</button>
    <button id="saveBtn">Save Project (.json)</button>
    <input type="file" id="loadFile" accept=".json" style="display:none;">
    <button id="loadBtn">Load Project (.json)</button>
    <input type="file" id="audioInput" accept="audio/*">
    <label>
      FPS:
      <input type="range" id="fpsSlider" min="1" max="30" value="6">
      <span id="fpsValue">6</span>
    </label>
    <label>
      <input type="checkbox" id="onionSkin"> Onion Skin
    </label>
    <select id="onionMode">
      <option value="previous">Previous Frame</option>
      <option value="next">Next Frame</option>
      <option value="both">Previous + Next</option>
    </select>
  </div>

  <audio id="audio" controls></audio>
  <div id="timeline"></div>

  <script>
    const video = document.getElementById("webcam");
    const liveCanvas = document.getElementById("liveCanvas");
    const liveCtx = liveCanvas.getContext("2d");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const captureBtn = document.getElementById("captureBtn");
    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const exportBtn = document.getElementById("exportBtn");
    const fpsSlider = document.getElementById("fpsSlider");
    const fpsValue = document.getElementById("fpsValue");
    const audio = document.getElementById("audio");
    const audioInput = document.getElementById("audioInput");
    const timeline = document.getElementById("timeline");
    const playbackPreview = document.getElementById("playbackPreview");
    const onionSkinToggle = document.getElementById("onionSkin");
    const onionMode = document.getElementById("onionMode");

    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const loadFile = document.getElementById("loadFile");

    let frames = [];
    let currentFrame = 0;
    let playing = false;
    let playInterval = null;
    let audioFilename = "";
    let dragSrcIndex = null;

    // Webcam setup
    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      requestAnimationFrame(drawLive);
    });

// Live camera with onion skin (previous + next)
function drawLive() {
  // draw the live webcam feed
  liveCtx.globalAlpha = 1.0;
  liveCtx.drawImage(video, 0, 0, liveCanvas.width, liveCanvas.height);

  if (onionSkinToggle.checked && frames.length > 0) {
    const alphaStep = 0.3; // transparency for onion layers
    const prevIndex = currentFrame - 1;
    const nextIndex = currentFrame + 1;

    // draw previous frame (if exists)
    if (prevIndex >= 0) {
      const prevImg = new Image();
      prevImg.src = frames[prevIndex];
      liveCtx.globalAlpha = alphaStep;
      liveCtx.drawImage(prevImg, 0, 0, liveCanvas.width, liveCanvas.height);
    }

    // draw next frame (if exists)
    if (nextIndex < frames.length) {
      const nextImg = new Image();
      nextImg.src = frames[nextIndex];
      liveCtx.globalAlpha = alphaStep;
      liveCtx.drawImage(nextImg, 0, 0, liveCanvas.width, liveCanvas.height);
    }

    liveCtx.globalAlpha = 1.0; // reset
  }

  requestAnimationFrame(drawLive);
}


    // FPS slider value display
    fpsSlider.addEventListener("input", () => {
      fpsValue.textContent = fpsSlider.value;
    });

    // Capture frame
    captureBtn.addEventListener("click", () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL();
      frames.push(dataURL);
      renderTimeline();
    });

    // Timeline renderer with drag/drop
    function renderTimeline() {
      timeline.innerHTML = "";
      frames.forEach((frame, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "frame-thumb";
        wrapper.draggable = true;
        if (index === currentFrame) wrapper.classList.add("selected");

        const img = document.createElement("img");
        img.src = frame;
        wrapper.appendChild(img);

        const actions = document.createElement("div");
        actions.className = "frame-actions";

        const dupBtn = document.createElement("button");
        dupBtn.textContent = "â§‰";
        dupBtn.onclick = () => { frames.splice(index + 1, 0, frame); renderTimeline(); };

        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.onclick = () => { frames.splice(index, 1); if (currentFrame >= frames.length) currentFrame = frames.length - 1; renderTimeline(); };

        actions.appendChild(dupBtn);
        actions.appendChild(delBtn);
        wrapper.appendChild(actions);

        wrapper.onclick = () => {
          currentFrame = index;
          renderTimeline();
        };

        // Drag events
        wrapper.addEventListener("dragstart", e => {
          dragSrcIndex = index;
          wrapper.classList.add("dragging");
        });
        wrapper.addEventListener("dragend", e => {
          wrapper.classList.remove("dragging");
        });
        wrapper.addEventListener("dragover", e => {
          e.preventDefault();
        });
        wrapper.addEventListener("drop", e => {
          e.preventDefault();
          if (dragSrcIndex !== null && dragSrcIndex !== index) {
            const movedFrame = frames.splice(dragSrcIndex, 1)[0];
            frames.splice(index, 0, movedFrame);
            dragSrcIndex = null;
            renderTimeline();
          }
        });

        timeline.appendChild(wrapper);
      });
    }

    // Audio upload
    audioInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) {
        audioFilename = file.name;
        audio.src = URL.createObjectURL(file);
      }
    });

    // Playback
    playBtn.addEventListener("click", () => {
      if (frames.length === 0) return;
      playing = true;
      currentFrame = 0;
      const fps = parseInt(fpsSlider.value);
      const frameDuration = 1000 / fps;

      audio.currentTime = 0;
      audio.play();

      playInterval = setInterval(() => {
        if (currentFrame < frames.length) {
          playbackPreview.src = frames[currentFrame];
          document.querySelectorAll(".frame-thumb").forEach((el, i) => {
            el.classList.toggle("selected", i === currentFrame);
          });
          currentFrame++;
        } else {
          stopPlayback();
        }
      }, frameDuration);
    });

    stopBtn.addEventListener("click", stopPlayback);

    function stopPlayback() {
      playing = false;
      clearInterval(playInterval);
      audio.pause();
      audio.currentTime = 0;
      currentFrame = 0;
      playbackPreview.src = "";
      renderTimeline();
    }

    // Export WebM (silent, single file, no looping)
    exportBtn.addEventListener("click", () => {
      if (frames.length === 0) return;

      const fps = parseInt(fpsSlider.value);
      const exportCanvas = document.createElement("canvas");
      const exportCtx = exportCanvas.getContext("2d");

      const img0 = new Image();
      img0.onload = () => {
        exportCanvas.width = img0.width;
        exportCanvas.height = img0.height;

        const stream = exportCanvas.captureStream(fps);
        const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
        const chunks = [];

        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => {
          const blob = new Blob(chunks, { type: "video/webm" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "animation.webm";
          a.click();
        };

        recorder.start();

        let i = 0;
        const drawFrame = () => {
          if (i < frames.length) {
            const img = new Image();
            img.onload = () => {
              exportCtx.drawImage(img, 0, 0);
              i++;
              setTimeout(drawFrame, 1000 / fps);
            };
            img.src = frames[i];
          } else {
            recorder.stop();
          }
        };

        drawFrame();
      };
      img0.src = frames[0];
    });

    // Save Project (.json)
    saveBtn.addEventListener("click", () => {
      if (frames.length === 0) return;
      const projectData = {
        frames: frames,
        fps: parseInt(fpsSlider.value),
        audio: audioFilename
      };
      const blob = new Blob([JSON.stringify(projectData)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "project.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    // Load Project (.json)
    loadBtn.addEventListener("click", () => {
      loadFile.click();
    });

    loadFile.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = event => {
        try {
          const projectData = JSON.parse(event.target.result);
          frames = projectData.frames || [];
          fpsSlider.value = projectData.fps || 6;
          fpsValue.textContent = fpsSlider.value;
          audioFilename = projectData.audio || "";
          currentFrame = 0;
          renderTimeline();
          alert("Project loaded! Remember to re-import your audio file: " + audioFilename);
        } catch (err) {
          alert("Invalid project file!");
        }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>
