<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SillyMotion</title>
  <style>
    body {
      font-family: "Comic Sans MS", "Comic Sans", cursive;
      margin: 20px;
      background: #fff;
      color: #000;
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      background: #121212;
      color: #eee;
    }

    header {
      text-align: center;
      margin-bottom: 10px;
    }

    .logo {
      width: 700px;
      max-width: 90%;
    }

    #controls { margin: 10px 0; }

    #timeline {
      display: flex;
      overflow-x: auto;
      border: 1px solid #ccc;
      padding: 5px;
      min-height: 100px;
    }

    body.dark #timeline {
      border-color: #444;
    }

    .frame-thumb {
      margin: 2px;
      border: 1px solid #999;
      cursor: grab;
      position: relative;
      background: #f0f0f0;
    }

    body.dark .frame-thumb {
      background: #1e1e1e;
      border-color: #666;
    }

    .frame-thumb.dragging { opacity: 0.5; }

    .frame-thumb img {
      width: 60px;
      height: 45px;
      display: block;
    }

    .selected { border: 2px solid red; }

    .frame-actions {
      display: flex;
      justify-content: center;
      margin-top: 2px;
    }

    .frame-actions button {
      font-size: 10px;
      margin: 0 1px;
    }

    button, input, select {
      background: #fff;
      color: #000;
      border: 1px solid #aaa;
      padding: 2px 6px;
      border-radius: 4px;
    }

    body.dark button, 
    body.dark input, 
    body.dark select {
      background: #333;
      color: #eee;
      border-color: #666;
    }

    a { color: #06c; }
    body.dark a { color: #4af; }

    /* Export message styling */
    #exportMessage {
      display: none;
      font-weight: bold;
      margin-top: 10px;
      color: green;
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="SillyMotion Logo" class="logo">
    <p><a href="README.txt" target="_blank">ðŸ“– Read Me (Instructions & Features)</a></p>
<button onclick="openJSPaint()">Wanna Draw Some Scenes? Open JS Paint!</button>

    <script>
        function openJSPaint() {
            // Open JS Paint in a new window
            window.open('jspaint-1.0.0-beta.1/jspaint-1.0.0-beta.1/index.html', '_blank');
        }
    </script>
  </header>

  <div style="display:flex; gap:20px; flex-wrap:wrap;">
    <div>
      <h3>Camera Feed</h3>
      <canvas id="liveCanvas" width="320" height="240" style="border:1px solid #ccc;"></canvas>
      <video id="webcam" autoplay playsinline width="320" height="240" style="display:none;"></video>
      <canvas id="canvas" width="320" height="240" style="display:none;"></canvas>
    </div>

    <div>
      <h3>Playback Preview</h3>
      <img id="playbackPreview" width="320" height="240" style="border:1px solid #ccc;">
    </div>

    <div>
      <h3>Demo</h3>
      <iframe 
        width="480" 
        height="270" 
        src="https://www.youtube.com/embed/m3WjCsxfhnc" 
        title="SillyMotion Demo"
        frameborder="0" 
        allowfullscreen>
      </iframe>
    </div>
  </div>

  <div id="controls">
    <button id="captureBtn">Capture Frame</button>
    <button id="playBtn">Play</button>
    <button id="stopBtn">Stop</button>
    <button id="exportBtn">Export WebM</button>
    <button id="saveBtn">Save Project (.json)</button>
    <input type="file" id="loadFile" accept=".json" style="display:none;">
    <button id="loadBtn">Load Project (.json)</button>
    <input type="file" id="audioInput" accept="audio/*">
    <label>
      FPS:
      <input type="range" id="fpsSlider" min="1" max="30" value="6">
      <span id="fpsValue">6</span>
    </label>
    <label>
      <input type="checkbox" id="onionSkin"> Onion Skin
    </label>
    <select id="onionMode">
      <option value="previous">Previous Frame</option>
      <option value="next">Next Frame</option>
      <option value="both">Previous + Next</option>
    </select>
    <button id="darkToggle">ðŸŒ™ Toggle Dark Mode</button>

    <!-- New image import button -->
    <input type="file" id="importImages" accept="image/*" multiple style="display:none;">
    <button id="importBtn">Import Images as Frames</button>
  </div>

  <audio id="audio" controls></audio>

  <div id="frameInfo" style="margin-bottom:5px; font-weight:bold;">Frames: 0 | Current: 0</div>
  <div id="timeline"></div>
  <div id="exportMessage">Exporting Your Animation! Please Wait!</div>

  <script>
    const darkToggle = document.getElementById("darkToggle");
    darkToggle.addEventListener("click", () => document.body.classList.toggle("dark"));

    const video = document.getElementById("webcam");
    const liveCanvas = document.getElementById("liveCanvas");
    const liveCtx = liveCanvas.getContext("2d");
    const canvas = document.getElementById("canvas");
    const ctx = canvas.getContext("2d");
    const captureBtn = document.getElementById("captureBtn");
    const playBtn = document.getElementById("playBtn");
    const stopBtn = document.getElementById("stopBtn");
    const exportBtn = document.getElementById("exportBtn");
    const fpsSlider = document.getElementById("fpsSlider");
    const fpsValue = document.getElementById("fpsValue");
    const audio = document.getElementById("audio");
    const audioInput = document.getElementById("audioInput");
    const timeline = document.getElementById("timeline");
    const playbackPreview = document.getElementById("playbackPreview");
    const onionSkinToggle = document.getElementById("onionSkin");
    const onionMode = document.getElementById("onionMode");
    const saveBtn = document.getElementById("saveBtn");
    const loadBtn = document.getElementById("loadBtn");
    const loadFile = document.getElementById("loadFile");
    const frameInfo = document.getElementById("frameInfo");
    const exportMessage = document.getElementById("exportMessage");

    // New image import elements
    const importBtn = document.getElementById("importBtn");
    const importImages = document.getElementById("importImages");

    let frames = [];
    let currentFrame = 0;
    let playing = false;
    let playInterval = null;
    let audioFilename = "";
    let dragSrcIndex = null;

    navigator.mediaDevices.getUserMedia({ video: true }).then(stream => {
      video.srcObject = stream;
      requestAnimationFrame(drawLive);
    });

    function drawLive() {
      liveCtx.globalAlpha = 1.0;
      liveCtx.drawImage(video, 0, 0, liveCanvas.width, liveCanvas.height);

      if (onionSkinToggle.checked && frames.length > 0) {
        const alphaStep = 0.3;
        const prevIndex = currentFrame - 1;
        const nextIndex = currentFrame + 1;

        if (prevIndex >= 0) {
          const prevImg = new Image();
          prevImg.src = frames[prevIndex];
          liveCtx.globalAlpha = alphaStep;
          liveCtx.drawImage(prevImg, 0, 0, liveCanvas.width, liveCanvas.height);
        }
        if (nextIndex < frames.length) {
          const nextImg = new Image();
          nextImg.src = frames[nextIndex];
          liveCtx.globalAlpha = alphaStep;
          liveCtx.drawImage(nextImg, 0, 0, liveCanvas.width, liveCanvas.height);
        }
        liveCtx.globalAlpha = 1.0;
      }
      requestAnimationFrame(drawLive);
    }

    fpsSlider.addEventListener("input", () => { fpsValue.textContent = fpsSlider.value; });

    function updateFrameInfo() {
      const total = frames.length;
      const current = frames.length === 0 ? 0 : playing ? Math.min(currentFrame + 1, total) : currentFrame + 1;
      frameInfo.textContent = `Frames: ${total} | Current: ${current}`;
    }

    captureBtn.addEventListener("click", () => {
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL();
      frames.push(dataURL);
      renderTimeline();
      updateFrameInfo();
    });

    // Image import logic
    importBtn.addEventListener("click", () => importImages.click());

    importImages.addEventListener("change", e => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      files.forEach(file => {
        const reader = new FileReader();
        reader.onload = event => {
          frames.push(event.target.result);
          renderTimeline();
          updateFrameInfo();
        };
        reader.readAsDataURL(file);
      });

      importImages.value = "";
    });

    function renderTimeline() {
      timeline.innerHTML = "";
      frames.forEach((frame, index) => {
        const wrapper = document.createElement("div");
        wrapper.className = "frame-thumb";
        wrapper.draggable = true;
        if (index === currentFrame) wrapper.classList.add("selected");

        const img = document.createElement("img");
        img.src = frame;
        wrapper.appendChild(img);

        const actions = document.createElement("div");
        actions.className = "frame-actions";

        const dupBtn = document.createElement("button");
        dupBtn.textContent = "â§‰";
        dupBtn.onclick = () => { frames.splice(index + 1, 0, frame); renderTimeline(); updateFrameInfo(); };

        const delBtn = document.createElement("button");
        delBtn.textContent = "âœ•";
        delBtn.onclick = () => { frames.splice(index, 1); if (currentFrame >= frames.length) currentFrame = frames.length - 1; renderTimeline(); updateFrameInfo(); };

        actions.appendChild(dupBtn);
        actions.appendChild(delBtn);
        wrapper.appendChild(actions);

        wrapper.onclick = () => { currentFrame = index; renderTimeline(); updateFrameInfo(); };

        wrapper.addEventListener("dragstart", e => { dragSrcIndex = index; wrapper.classList.add("dragging"); });
        wrapper.addEventListener("dragend", e => { wrapper.classList.remove("dragging"); });
        wrapper.addEventListener("dragover", e => e.preventDefault());
        wrapper.addEventListener("drop", e => {
          e.preventDefault();
          if (dragSrcIndex !== null && dragSrcIndex !== index) {
            const movedFrame = frames.splice(dragSrcIndex, 1)[0];
            frames.splice(index, 0, movedFrame);
            dragSrcIndex = null;
            renderTimeline();
            updateFrameInfo();
          }
        });

        timeline.appendChild(wrapper);
      });
      updateFrameInfo();
    }

    audioInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (file) { audioFilename = file.name; audio.src = URL.createObjectURL(file); }
    });

    playBtn.addEventListener("click", () => {
      if (frames.length === 0) return;
      playing = true;
      currentFrame = 0;
      const fps = parseInt(fpsSlider.value);
      const frameDuration = 1000 / fps;

      audio.currentTime = 0;
      audio.play();

      playInterval = setInterval(() => {
        if (currentFrame < frames.length) {
          playbackPreview.src = frames[currentFrame];
          document.querySelectorAll(".frame-thumb").forEach((el, i) => el.classList.toggle("selected", i === currentFrame));
          updateFrameInfo();
          currentFrame++;
        } else { stopPlayback(); }
      }, frameDuration);
    });

    stopBtn.addEventListener("click", stopPlayback);

    function stopPlayback() {
      playing = false;
      clearInterval(playInterval);
      audio.pause();
      audio.currentTime = 0;
      currentFrame = 0;
      playbackPreview.src = "";
      renderTimeline();
      updateFrameInfo();
    }

    exportBtn.addEventListener("click", () => {
  if (frames.length === 0) return;
  exportMessage.style.display = "block";

  const fps = parseInt(fpsSlider.value);
  const exportCanvas = document.createElement("canvas");
  const exportCtx = exportCanvas.getContext("2d");

  const img0 = new Image();
  img0.onload = () => {
    exportCanvas.width = img0.width;
    exportCanvas.height = img0.height;

    const stream = exportCanvas.captureStream(fps);
    const recorder = new MediaRecorder(stream, { mimeType: "video/webm" });
    const chunks = [];

    recorder.ondataavailable = e => chunks.push(e.data);
    recorder.onstop = () => {
      const blob = new Blob(chunks, { type: "video/webm" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "animation.webm";
      a.click();
      setTimeout(() => { exportMessage.style.display = "none"; }, 100);
    };

    recorder.start();

    let i = 0;
    const drawFrame = () => {
      if (i >= frames.length) {
        recorder.stop();
        return;
      }

      const img = new Image();
      img.onload = () => {
        exportCtx.clearRect(0, 0, exportCanvas.width, exportCanvas.height);
        exportCtx.drawImage(img, 0, 0);
        i++;
        setTimeout(drawFrame, 1000 / fps);
      };
      img.src = frames[i];
    };

    drawFrame();
  };
  img0.src = frames[0];
});


    saveBtn.addEventListener("click", () => {
      if (frames.length === 0) return;
      const projectData = { frames, fps: parseInt(fpsSlider.value), audio: audioFilename };
      const blob = new Blob([JSON.stringify(projectData)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "project.json";
      a.click();
      URL.revokeObjectURL(url);
    });

    loadBtn.addEventListener("click", () => loadFile.click());
    loadFile.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = event => {
        try {
          const projectData = JSON.parse(event.target.result);
          frames = projectData.frames || [];
          fpsSlider.value = projectData.fps || 6;
          fpsValue.textContent = fpsSlider.value;
          audioFilename = projectData.audio || "";
          currentFrame = 0;
          renderTimeline();
          updateFrameInfo();
          alert("Project loaded! Remember to re-import your audio file: " + audioFilename);
        } catch { alert("Invalid project file!"); }
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>

